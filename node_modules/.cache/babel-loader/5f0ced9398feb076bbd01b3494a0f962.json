{"ast":null,"code":"import { uuid4, timestampWithMs, logger, dropUndefinedKeys } from '@sentry/utils';\n\n/**\n * Keeps track of finished spans for a given transaction\n * @internal\n * @hideconstructor\n * @hidden\n */\nclass SpanRecorder {\n  __init() {\n    this.spans = [];\n  }\n  constructor() {\n    let maxlen = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1000;\n    SpanRecorder.prototype.__init.call(this);\n    this._maxlen = maxlen;\n  }\n\n  /**\n   * This is just so that we don't run out of memory while recording a lot\n   * of spans. At some point we just stop and flush out the start of the\n   * trace tree (i.e.the first n spans with the smallest\n   * start_timestamp).\n   */\n  add(span) {\n    if (this.spans.length > this._maxlen) {\n      span.spanRecorder = undefined;\n    } else {\n      this.spans.push(span);\n    }\n  }\n}\n\n/**\n * Span contains all data about a span\n */\nclass Span {\n  /**\n   * @inheritDoc\n   */\n  __init2() {\n    this.traceId = uuid4();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  __init3() {\n    this.spanId = uuid4().substring(16);\n  }\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * Internal keeper of the status\n   */\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * Timestamp in seconds when the span was created.\n   */\n  __init4() {\n    this.startTimestamp = timestampWithMs();\n  }\n\n  /**\n   * Timestamp in seconds when the span ended.\n   */\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * @inheritDoc\n   */\n  __init5() {\n    this.tags = {};\n  }\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  __init6() {\n    this.data = {};\n  }\n\n  /**\n   * List of spans that were finalized\n   */\n\n  /**\n   * @inheritDoc\n   */\n\n  /**\n   * The instrumenter that created this span.\n   */\n  __init7() {\n    this.instrumenter = 'sentry';\n  }\n\n  /**\n   * You should never call the constructor manually, always use `Sentry.startTransaction()`\n   * or call `startChild()` on an existing span.\n   * @internal\n   * @hideconstructor\n   * @hidden\n   */\n  constructor(spanContext) {\n    Span.prototype.__init2.call(this);\n    Span.prototype.__init3.call(this);\n    Span.prototype.__init4.call(this);\n    Span.prototype.__init5.call(this);\n    Span.prototype.__init6.call(this);\n    Span.prototype.__init7.call(this);\n    if (!spanContext) {\n      return this;\n    }\n    if (spanContext.traceId) {\n      this.traceId = spanContext.traceId;\n    }\n    if (spanContext.spanId) {\n      this.spanId = spanContext.spanId;\n    }\n    if (spanContext.parentSpanId) {\n      this.parentSpanId = spanContext.parentSpanId;\n    }\n    // We want to include booleans as well here\n    if ('sampled' in spanContext) {\n      this.sampled = spanContext.sampled;\n    }\n    if (spanContext.op) {\n      this.op = spanContext.op;\n    }\n    if (spanContext.description) {\n      this.description = spanContext.description;\n    }\n    if (spanContext.data) {\n      this.data = spanContext.data;\n    }\n    if (spanContext.tags) {\n      this.tags = spanContext.tags;\n    }\n    if (spanContext.status) {\n      this.status = spanContext.status;\n    }\n    if (spanContext.startTimestamp) {\n      this.startTimestamp = spanContext.startTimestamp;\n    }\n    if (spanContext.endTimestamp) {\n      this.endTimestamp = spanContext.endTimestamp;\n    }\n    if (spanContext.instrumenter) {\n      this.instrumenter = spanContext.instrumenter;\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n  startChild(spanContext) {\n    const childSpan = new Span({\n      ...spanContext,\n      parentSpanId: this.spanId,\n      sampled: this.sampled,\n      traceId: this.traceId\n    });\n    childSpan.spanRecorder = this.spanRecorder;\n    if (childSpan.spanRecorder) {\n      childSpan.spanRecorder.add(childSpan);\n    }\n    childSpan.transaction = this.transaction;\n    if ((typeof __SENTRY_DEBUG__ === 'undefined' || __SENTRY_DEBUG__) && childSpan.transaction) {\n      const opStr = spanContext && spanContext.op || '< unknown op >';\n      const nameStr = childSpan.transaction.name || '< unknown name >';\n      const idStr = childSpan.transaction.spanId;\n      const logMessage = `[Tracing] Starting '${opStr}' span on transaction '${nameStr}' (${idStr}).`;\n      childSpan.transaction.metadata.spanMetadata[childSpan.spanId] = {\n        logMessage\n      };\n      logger.log(logMessage);\n    }\n    return childSpan;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  setTag(key, value) {\n    this.tags = {\n      ...this.tags,\n      [key]: value\n    };\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types\n  setData(key, value) {\n    this.data = {\n      ...this.data,\n      [key]: value\n    };\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  setStatus(value) {\n    this.status = value;\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  setHttpStatus(httpStatus) {\n    this.setTag('http.status_code', String(httpStatus));\n    const spanStatus = spanStatusfromHttpCode(httpStatus);\n    if (spanStatus !== 'unknown_error') {\n      this.setStatus(spanStatus);\n    }\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  isSuccess() {\n    return this.status === 'ok';\n  }\n\n  /**\n   * @inheritDoc\n   */\n  finish(endTimestamp) {\n    if ((typeof __SENTRY_DEBUG__ === 'undefined' || __SENTRY_DEBUG__) &&\n    // Don't call this for transactions\n    this.transaction && this.transaction.spanId !== this.spanId) {\n      const {\n        logMessage\n      } = this.transaction.metadata.spanMetadata[this.spanId];\n      if (logMessage) {\n        logger.log(logMessage.replace('Starting', 'Finishing'));\n      }\n    }\n    this.endTimestamp = typeof endTimestamp === 'number' ? endTimestamp : timestampWithMs();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  toTraceparent() {\n    let sampledString = '';\n    if (this.sampled !== undefined) {\n      sampledString = this.sampled ? '-1' : '-0';\n    }\n    return `${this.traceId}-${this.spanId}${sampledString}`;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  toContext() {\n    return dropUndefinedKeys({\n      data: this.data,\n      description: this.description,\n      endTimestamp: this.endTimestamp,\n      op: this.op,\n      parentSpanId: this.parentSpanId,\n      sampled: this.sampled,\n      spanId: this.spanId,\n      startTimestamp: this.startTimestamp,\n      status: this.status,\n      tags: this.tags,\n      traceId: this.traceId\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  updateWithContext(spanContext) {\n    this.data = spanContext.data || {};\n    this.description = spanContext.description;\n    this.endTimestamp = spanContext.endTimestamp;\n    this.op = spanContext.op;\n    this.parentSpanId = spanContext.parentSpanId;\n    this.sampled = spanContext.sampled;\n    this.spanId = spanContext.spanId || this.spanId;\n    this.startTimestamp = spanContext.startTimestamp || this.startTimestamp;\n    this.status = spanContext.status;\n    this.tags = spanContext.tags || {};\n    this.traceId = spanContext.traceId || this.traceId;\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  getTraceContext() {\n    return dropUndefinedKeys({\n      data: Object.keys(this.data).length > 0 ? this.data : undefined,\n      description: this.description,\n      op: this.op,\n      parent_span_id: this.parentSpanId,\n      span_id: this.spanId,\n      status: this.status,\n      tags: Object.keys(this.tags).length > 0 ? this.tags : undefined,\n      trace_id: this.traceId\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  toJSON() {\n    return dropUndefinedKeys({\n      data: Object.keys(this.data).length > 0 ? this.data : undefined,\n      description: this.description,\n      op: this.op,\n      parent_span_id: this.parentSpanId,\n      span_id: this.spanId,\n      start_timestamp: this.startTimestamp,\n      status: this.status,\n      tags: Object.keys(this.tags).length > 0 ? this.tags : undefined,\n      timestamp: this.endTimestamp,\n      trace_id: this.traceId\n    });\n  }\n}\n\n/**\n * Converts a HTTP status code into a {@link SpanStatusType}.\n *\n * @param httpStatus The HTTP response status code.\n * @returns The span status or unknown_error.\n */\nfunction spanStatusfromHttpCode(httpStatus) {\n  if (httpStatus < 400 && httpStatus >= 100) {\n    return 'ok';\n  }\n  if (httpStatus >= 400 && httpStatus < 500) {\n    switch (httpStatus) {\n      case 401:\n        return 'unauthenticated';\n      case 403:\n        return 'permission_denied';\n      case 404:\n        return 'not_found';\n      case 409:\n        return 'already_exists';\n      case 413:\n        return 'failed_precondition';\n      case 429:\n        return 'resource_exhausted';\n      default:\n        return 'invalid_argument';\n    }\n  }\n  if (httpStatus >= 500 && httpStatus < 600) {\n    switch (httpStatus) {\n      case 501:\n        return 'unimplemented';\n      case 503:\n        return 'unavailable';\n      case 504:\n        return 'deadline_exceeded';\n      default:\n        return 'internal_error';\n    }\n  }\n  return 'unknown_error';\n}\nexport { Span, SpanRecorder, spanStatusfromHttpCode };","map":{"version":3,"sources":["../../../src/tracing/span.ts"],"names":[],"mappings":";;AAWA;AACA;AACA;AACA;AACA;AACA;AACA,MAAA,YAAA,CAAA;EACA,MAAA,GAAA;IAAA,IAAA,CAAA,KAAA,GAAA,EAAA;EAAA;EAIA,WAAA,GAAA;IAAA,IAAA,MAAA,uEAAA,IAAA;IAAA,YAAA,CAAA,SAAA,CAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IACA,IAAA,CAAA,OAAA,GAAA,MAAA;EACA;;EAEA;AACA;AACA;AACA;AACA;AACA;EACA,GAAA,CAAA,IAAA,EAAA;IACA,IAAA,IAAA,CAAA,KAAA,CAAA,MAAA,GAAA,IAAA,CAAA,OAAA,EAAA;MACA,IAAA,CAAA,YAAA,GAAA,SAAA;IACA,CAAA,MAAA;MACA,IAAA,CAAA,KAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IACA;EACA;AACA;;AAEA;AACA;AACA;AACA,MAAA,IAAA,CAAA;EACA;AACA;AACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,OAAA,GAAA,KAAA,EAAA;EAAA;;EAEA;AACA;AACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,MAAA,GAAA,KAAA,EAAA,CAAA,SAAA,CAAA,EAAA,CAAA;EAAA;;EAEA;AACA;AACA;;EAGA;AACA;AACA;;EAGA;AACA;AACA;;EAGA;AACA;AACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,cAAA,GAAA,eAAA,EAAA;EAAA;;EAEA;AACA;AACA;;EAGA;AACA;AACA;;EAGA;AACA;AACA;;EAGA;AACA;AACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,IAAA,GAAA,CAAA,CAAA;EAAA;;EAEA;AACA;AACA;EACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,IAAA,GAAA,CAAA,CAAA;EAAA;;EAEA;AACA;AACA;;EAGA;AACA;AACA;;EAGA;AACA;AACA;EACA,OAAA,GAAA;IAAA,IAAA,CAAA,YAAA,GAAA,QAAA;EAAA;;EAEA;AACA;AACA;AACA;AACA;AACA;AACA;EACA,WAAA,CAAA,WAAA,EAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IAAA,IAAA,CAAA,SAAA,CAAA,OAAA,CAAA,IAAA,CAAA,IAAA,CAAA;IACA,IAAA,CAAA,WAAA,EAAA;MACA,OAAA,IAAA;IACA;IACA,IAAA,WAAA,CAAA,OAAA,EAAA;MACA,IAAA,CAAA,OAAA,GAAA,WAAA,CAAA,OAAA;IACA;IACA,IAAA,WAAA,CAAA,MAAA,EAAA;MACA,IAAA,CAAA,MAAA,GAAA,WAAA,CAAA,MAAA;IACA;IACA,IAAA,WAAA,CAAA,YAAA,EAAA;MACA,IAAA,CAAA,YAAA,GAAA,WAAA,CAAA,YAAA;IACA;IACA;IACA,IAAA,SAAA,IAAA,WAAA,EAAA;MACA,IAAA,CAAA,OAAA,GAAA,WAAA,CAAA,OAAA;IACA;IACA,IAAA,WAAA,CAAA,EAAA,EAAA;MACA,IAAA,CAAA,EAAA,GAAA,WAAA,CAAA,EAAA;IACA;IACA,IAAA,WAAA,CAAA,WAAA,EAAA;MACA,IAAA,CAAA,WAAA,GAAA,WAAA,CAAA,WAAA;IACA;IACA,IAAA,WAAA,CAAA,IAAA,EAAA;MACA,IAAA,CAAA,IAAA,GAAA,WAAA,CAAA,IAAA;IACA;IACA,IAAA,WAAA,CAAA,IAAA,EAAA;MACA,IAAA,CAAA,IAAA,GAAA,WAAA,CAAA,IAAA;IACA;IACA,IAAA,WAAA,CAAA,MAAA,EAAA;MACA,IAAA,CAAA,MAAA,GAAA,WAAA,CAAA,MAAA;IACA;IACA,IAAA,WAAA,CAAA,cAAA,EAAA;MACA,IAAA,CAAA,cAAA,GAAA,WAAA,CAAA,cAAA;IACA;IACA,IAAA,WAAA,CAAA,YAAA,EAAA;MACA,IAAA,CAAA,YAAA,GAAA,WAAA,CAAA,YAAA;IACA;IACA,IAAA,WAAA,CAAA,YAAA,EAAA;MACA,IAAA,CAAA,YAAA,GAAA,WAAA,CAAA,YAAA;IACA;EACA;;EAEA;AACA;AACA;EACA,UAAA,CACA,WAAA,EACA;IACA,MAAA,SAAA,GAAA,IAAA,IAAA,CAAA;MACA,GAAA,WAAA;MACA,YAAA,EAAA,IAAA,CAAA,MAAA;MACA,OAAA,EAAA,IAAA,CAAA,OAAA;MACA,OAAA,EAAA,IAAA,CAAA;IACA,CAAA,CAAA;IAEA,SAAA,CAAA,YAAA,GAAA,IAAA,CAAA,YAAA;IACA,IAAA,SAAA,CAAA,YAAA,EAAA;MACA,SAAA,CAAA,YAAA,CAAA,GAAA,CAAA,SAAA,CAAA;IACA;IAEA,SAAA,CAAA,WAAA,GAAA,IAAA,CAAA,WAAA;IAEA,IAAA,CAAA,OAAA,gBAAA,KAAA,WAAA,IAAA,gBAAA,KAAA,SAAA,CAAA,WAAA,EAAA;MACA,MAAA,KAAA,GAAA,WAAA,IAAA,WAAA,CAAA,EAAA,IAAA,gBAAA;MACA,MAAA,OAAA,GAAA,SAAA,CAAA,WAAA,CAAA,IAAA,IAAA,kBAAA;MACA,MAAA,KAAA,GAAA,SAAA,CAAA,WAAA,CAAA,MAAA;MAEA,MAAA,UAAA,GAAA,uBAAA,KAAA,0BAAA,OAAA,MAAA,KAAA,IAAA;MACA,SAAA,CAAA,WAAA,CAAA,QAAA,CAAA,YAAA,CAAA,SAAA,CAAA,MAAA,CAAA,GAAA;QAAA;MAAA,CAAA;MACA,MAAA,CAAA,GAAA,CAAA,UAAA,CAAA;IACA;IAEA,OAAA,SAAA;EACA;;EAEA;AACA;AACA;EACA,MAAA,CAAA,GAAA,EAAA,KAAA,EAAA;IACA,IAAA,CAAA,IAAA,GAAA;MAAA,GAAA,IAAA,CAAA,IAAA;MAAA,CAAA,GAAA,GAAA;IAAA,CAAA;IACA,OAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA;EACA,OAAA,CAAA,GAAA,EAAA,KAAA,EAAA;IACA,IAAA,CAAA,IAAA,GAAA;MAAA,GAAA,IAAA,CAAA,IAAA;MAAA,CAAA,GAAA,GAAA;IAAA,CAAA;IACA,OAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA,SAAA,CAAA,KAAA,EAAA;IACA,IAAA,CAAA,MAAA,GAAA,KAAA;IACA,OAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA,aAAA,CAAA,UAAA,EAAA;IACA,IAAA,CAAA,MAAA,CAAA,kBAAA,EAAA,MAAA,CAAA,UAAA,CAAA,CAAA;IACA,MAAA,UAAA,GAAA,sBAAA,CAAA,UAAA,CAAA;IACA,IAAA,UAAA,KAAA,eAAA,EAAA;MACA,IAAA,CAAA,SAAA,CAAA,UAAA,CAAA;IACA;IACA,OAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA,SAAA,GAAA;IACA,OAAA,IAAA,CAAA,MAAA,KAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA,MAAA,CAAA,YAAA,EAAA;IACA,IACA,CAAA,OAAA,gBAAA,KAAA,WAAA,IAAA,gBAAA;IACA;IACA,IAAA,CAAA,WAAA,IACA,IAAA,CAAA,WAAA,CAAA,MAAA,KAAA,IAAA,CAAA,MAAA,EACA;MACA,MAAA;QAAA;MAAA,CAAA,GAAA,IAAA,CAAA,WAAA,CAAA,QAAA,CAAA,YAAA,CAAA,IAAA,CAAA,MAAA,CAAA;MACA,IAAA,UAAA,EAAA;QACA,MAAA,CAAA,GAAA,CAAA,UAAA,CAAA,OAAA,CAAA,UAAA,EAAA,WAAA,CAAA,CAAA;MACA;IACA;IAEA,IAAA,CAAA,YAAA,GAAA,OAAA,YAAA,KAAA,QAAA,GAAA,YAAA,GAAA,eAAA,EAAA;EACA;;EAEA;AACA;AACA;EACA,aAAA,GAAA;IACA,IAAA,aAAA,GAAA,EAAA;IACA,IAAA,IAAA,CAAA,OAAA,KAAA,SAAA,EAAA;MACA,aAAA,GAAA,IAAA,CAAA,OAAA,GAAA,IAAA,GAAA,IAAA;IACA;IACA,OAAA,GAAA,IAAA,CAAA,OAAA,IAAA,IAAA,CAAA,MAAA,GAAA,aAAA,EAAA;EACA;;EAEA;AACA;AACA;EACA,SAAA,GAAA;IACA,OAAA,iBAAA,CAAA;MACA,IAAA,EAAA,IAAA,CAAA,IAAA;MACA,WAAA,EAAA,IAAA,CAAA,WAAA;MACA,YAAA,EAAA,IAAA,CAAA,YAAA;MACA,EAAA,EAAA,IAAA,CAAA,EAAA;MACA,YAAA,EAAA,IAAA,CAAA,YAAA;MACA,OAAA,EAAA,IAAA,CAAA,OAAA;MACA,MAAA,EAAA,IAAA,CAAA,MAAA;MACA,cAAA,EAAA,IAAA,CAAA,cAAA;MACA,MAAA,EAAA,IAAA,CAAA,MAAA;MACA,IAAA,EAAA,IAAA,CAAA,IAAA;MACA,OAAA,EAAA,IAAA,CAAA;IACA,CAAA,CAAA;EACA;;EAEA;AACA;AACA;EACA,iBAAA,CAAA,WAAA,EAAA;IACA,IAAA,CAAA,IAAA,GAAA,WAAA,CAAA,IAAA,IAAA,CAAA,CAAA;IACA,IAAA,CAAA,WAAA,GAAA,WAAA,CAAA,WAAA;IACA,IAAA,CAAA,YAAA,GAAA,WAAA,CAAA,YAAA;IACA,IAAA,CAAA,EAAA,GAAA,WAAA,CAAA,EAAA;IACA,IAAA,CAAA,YAAA,GAAA,WAAA,CAAA,YAAA;IACA,IAAA,CAAA,OAAA,GAAA,WAAA,CAAA,OAAA;IACA,IAAA,CAAA,MAAA,GAAA,WAAA,CAAA,MAAA,IAAA,IAAA,CAAA,MAAA;IACA,IAAA,CAAA,cAAA,GAAA,WAAA,CAAA,cAAA,IAAA,IAAA,CAAA,cAAA;IACA,IAAA,CAAA,MAAA,GAAA,WAAA,CAAA,MAAA;IACA,IAAA,CAAA,IAAA,GAAA,WAAA,CAAA,IAAA,IAAA,CAAA,CAAA;IACA,IAAA,CAAA,OAAA,GAAA,WAAA,CAAA,OAAA,IAAA,IAAA,CAAA,OAAA;IAEA,OAAA,IAAA;EACA;;EAEA;AACA;AACA;EACA,eAAA,GAAA;IACA,OAAA,iBAAA,CAAA;MACA,IAAA,EAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA,MAAA,GAAA,CAAA,GAAA,IAAA,CAAA,IAAA,GAAA,SAAA;MACA,WAAA,EAAA,IAAA,CAAA,WAAA;MACA,EAAA,EAAA,IAAA,CAAA,EAAA;MACA,cAAA,EAAA,IAAA,CAAA,YAAA;MACA,OAAA,EAAA,IAAA,CAAA,MAAA;MACA,MAAA,EAAA,IAAA,CAAA,MAAA;MACA,IAAA,EAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA,MAAA,GAAA,CAAA,GAAA,IAAA,CAAA,IAAA,GAAA,SAAA;MACA,QAAA,EAAA,IAAA,CAAA;IACA,CAAA,CAAA;EACA;;EAEA;AACA;AACA;EACA,MAAA,GAYA;IACA,OAAA,iBAAA,CAAA;MACA,IAAA,EAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA,MAAA,GAAA,CAAA,GAAA,IAAA,CAAA,IAAA,GAAA,SAAA;MACA,WAAA,EAAA,IAAA,CAAA,WAAA;MACA,EAAA,EAAA,IAAA,CAAA,EAAA;MACA,cAAA,EAAA,IAAA,CAAA,YAAA;MACA,OAAA,EAAA,IAAA,CAAA,MAAA;MACA,eAAA,EAAA,IAAA,CAAA,cAAA;MACA,MAAA,EAAA,IAAA,CAAA,MAAA;MACA,IAAA,EAAA,MAAA,CAAA,IAAA,CAAA,IAAA,CAAA,IAAA,CAAA,CAAA,MAAA,GAAA,CAAA,GAAA,IAAA,CAAA,IAAA,GAAA,SAAA;MACA,SAAA,EAAA,IAAA,CAAA,YAAA;MACA,QAAA,EAAA,IAAA,CAAA;IACA,CAAA,CAAA;EACA;AACA;;AAsCA;AACA;AACA;AACA;AACA;AACA;AACA,SAAA,sBAAA,CAAA,UAAA,EAAA;EACA,IAAA,UAAA,GAAA,GAAA,IAAA,UAAA,IAAA,GAAA,EAAA;IACA,OAAA,IAAA;EACA;EAEA,IAAA,UAAA,IAAA,GAAA,IAAA,UAAA,GAAA,GAAA,EAAA;IACA,QAAA,UAAA;MACA,KAAA,GAAA;QACA,OAAA,iBAAA;MACA,KAAA,GAAA;QACA,OAAA,mBAAA;MACA,KAAA,GAAA;QACA,OAAA,WAAA;MACA,KAAA,GAAA;QACA,OAAA,gBAAA;MACA,KAAA,GAAA;QACA,OAAA,qBAAA;MACA,KAAA,GAAA;QACA,OAAA,oBAAA;MACA;QACA,OAAA,kBAAA;IAAA;EAEA;EAEA,IAAA,UAAA,IAAA,GAAA,IAAA,UAAA,GAAA,GAAA,EAAA;IACA,QAAA,UAAA;MACA,KAAA,GAAA;QACA,OAAA,eAAA;MACA,KAAA,GAAA;QACA,OAAA,aAAA;MACA,KAAA,GAAA;QACA,OAAA,mBAAA;MACA;QACA,OAAA,gBAAA;IAAA;EAEA;EAEA,OAAA,eAAA;AACA","sourcesContent":["/* eslint-disable max-lines */\nimport type {\n  Instrumenter,\n  Primitive,\n  Span as SpanInterface,\n  SpanContext,\n  TraceContext,\n  Transaction,\n} from '@sentry/types';\nimport { dropUndefinedKeys, logger, timestampWithMs, uuid4 } from '@sentry/utils';\n\n/**\n * Keeps track of finished spans for a given transaction\n * @internal\n * @hideconstructor\n * @hidden\n */\nexport class SpanRecorder {\n  public spans: Span[] = [];\n\n  private readonly _maxlen: number;\n\n  public constructor(maxlen: number = 1000) {\n    this._maxlen = maxlen;\n  }\n\n  /**\n   * This is just so that we don't run out of memory while recording a lot\n   * of spans. At some point we just stop and flush out the start of the\n   * trace tree (i.e.the first n spans with the smallest\n   * start_timestamp).\n   */\n  public add(span: Span): void {\n    if (this.spans.length > this._maxlen) {\n      span.spanRecorder = undefined;\n    } else {\n      this.spans.push(span);\n    }\n  }\n}\n\n/**\n * Span contains all data about a span\n */\nexport class Span implements SpanInterface {\n  /**\n   * @inheritDoc\n   */\n  public traceId: string = uuid4();\n\n  /**\n   * @inheritDoc\n   */\n  public spanId: string = uuid4().substring(16);\n\n  /**\n   * @inheritDoc\n   */\n  public parentSpanId?: string;\n\n  /**\n   * Internal keeper of the status\n   */\n  public status?: SpanStatusType | string;\n\n  /**\n   * @inheritDoc\n   */\n  public sampled?: boolean;\n\n  /**\n   * Timestamp in seconds when the span was created.\n   */\n  public startTimestamp: number = timestampWithMs();\n\n  /**\n   * Timestamp in seconds when the span ended.\n   */\n  public endTimestamp?: number;\n\n  /**\n   * @inheritDoc\n   */\n  public op?: string;\n\n  /**\n   * @inheritDoc\n   */\n  public description?: string;\n\n  /**\n   * @inheritDoc\n   */\n  public tags: { [key: string]: Primitive } = {};\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  public data: { [key: string]: any } = {};\n\n  /**\n   * List of spans that were finalized\n   */\n  public spanRecorder?: SpanRecorder;\n\n  /**\n   * @inheritDoc\n   */\n  public transaction?: Transaction;\n\n  /**\n   * The instrumenter that created this span.\n   */\n  public instrumenter: Instrumenter = 'sentry';\n\n  /**\n   * You should never call the constructor manually, always use `Sentry.startTransaction()`\n   * or call `startChild()` on an existing span.\n   * @internal\n   * @hideconstructor\n   * @hidden\n   */\n  public constructor(spanContext?: SpanContext) {\n    if (!spanContext) {\n      return this;\n    }\n    if (spanContext.traceId) {\n      this.traceId = spanContext.traceId;\n    }\n    if (spanContext.spanId) {\n      this.spanId = spanContext.spanId;\n    }\n    if (spanContext.parentSpanId) {\n      this.parentSpanId = spanContext.parentSpanId;\n    }\n    // We want to include booleans as well here\n    if ('sampled' in spanContext) {\n      this.sampled = spanContext.sampled;\n    }\n    if (spanContext.op) {\n      this.op = spanContext.op;\n    }\n    if (spanContext.description) {\n      this.description = spanContext.description;\n    }\n    if (spanContext.data) {\n      this.data = spanContext.data;\n    }\n    if (spanContext.tags) {\n      this.tags = spanContext.tags;\n    }\n    if (spanContext.status) {\n      this.status = spanContext.status;\n    }\n    if (spanContext.startTimestamp) {\n      this.startTimestamp = spanContext.startTimestamp;\n    }\n    if (spanContext.endTimestamp) {\n      this.endTimestamp = spanContext.endTimestamp;\n    }\n    if (spanContext.instrumenter) {\n      this.instrumenter = spanContext.instrumenter;\n    }\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public startChild(\n    spanContext?: Pick<SpanContext, Exclude<keyof SpanContext, 'sampled' | 'traceId' | 'parentSpanId'>>,\n  ): Span {\n    const childSpan = new Span({\n      ...spanContext,\n      parentSpanId: this.spanId,\n      sampled: this.sampled,\n      traceId: this.traceId,\n    });\n\n    childSpan.spanRecorder = this.spanRecorder;\n    if (childSpan.spanRecorder) {\n      childSpan.spanRecorder.add(childSpan);\n    }\n\n    childSpan.transaction = this.transaction;\n\n    if (__DEBUG_BUILD__ && childSpan.transaction) {\n      const opStr = (spanContext && spanContext.op) || '< unknown op >';\n      const nameStr = childSpan.transaction.name || '< unknown name >';\n      const idStr = childSpan.transaction.spanId;\n\n      const logMessage = `[Tracing] Starting '${opStr}' span on transaction '${nameStr}' (${idStr}).`;\n      childSpan.transaction.metadata.spanMetadata[childSpan.spanId] = { logMessage };\n      logger.log(logMessage);\n    }\n\n    return childSpan;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setTag(key: string, value: Primitive): this {\n    this.tags = { ...this.tags, [key]: value };\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any, @typescript-eslint/explicit-module-boundary-types\n  public setData(key: string, value: any): this {\n    this.data = { ...this.data, [key]: value };\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setStatus(value: SpanStatusType): this {\n    this.status = value;\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public setHttpStatus(httpStatus: number): this {\n    this.setTag('http.status_code', String(httpStatus));\n    const spanStatus = spanStatusfromHttpCode(httpStatus);\n    if (spanStatus !== 'unknown_error') {\n      this.setStatus(spanStatus);\n    }\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public isSuccess(): boolean {\n    return this.status === 'ok';\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public finish(endTimestamp?: number): void {\n    if (\n      __DEBUG_BUILD__ &&\n      // Don't call this for transactions\n      this.transaction &&\n      this.transaction.spanId !== this.spanId\n    ) {\n      const { logMessage } = this.transaction.metadata.spanMetadata[this.spanId];\n      if (logMessage) {\n        logger.log((logMessage as string).replace('Starting', 'Finishing'));\n      }\n    }\n\n    this.endTimestamp = typeof endTimestamp === 'number' ? endTimestamp : timestampWithMs();\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public toTraceparent(): string {\n    let sampledString = '';\n    if (this.sampled !== undefined) {\n      sampledString = this.sampled ? '-1' : '-0';\n    }\n    return `${this.traceId}-${this.spanId}${sampledString}`;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public toContext(): SpanContext {\n    return dropUndefinedKeys({\n      data: this.data,\n      description: this.description,\n      endTimestamp: this.endTimestamp,\n      op: this.op,\n      parentSpanId: this.parentSpanId,\n      sampled: this.sampled,\n      spanId: this.spanId,\n      startTimestamp: this.startTimestamp,\n      status: this.status,\n      tags: this.tags,\n      traceId: this.traceId,\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public updateWithContext(spanContext: SpanContext): this {\n    this.data = spanContext.data || {};\n    this.description = spanContext.description;\n    this.endTimestamp = spanContext.endTimestamp;\n    this.op = spanContext.op;\n    this.parentSpanId = spanContext.parentSpanId;\n    this.sampled = spanContext.sampled;\n    this.spanId = spanContext.spanId || this.spanId;\n    this.startTimestamp = spanContext.startTimestamp || this.startTimestamp;\n    this.status = spanContext.status;\n    this.tags = spanContext.tags || {};\n    this.traceId = spanContext.traceId || this.traceId;\n\n    return this;\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public getTraceContext(): TraceContext {\n    return dropUndefinedKeys({\n      data: Object.keys(this.data).length > 0 ? this.data : undefined,\n      description: this.description,\n      op: this.op,\n      parent_span_id: this.parentSpanId,\n      span_id: this.spanId,\n      status: this.status,\n      tags: Object.keys(this.tags).length > 0 ? this.tags : undefined,\n      trace_id: this.traceId,\n    });\n  }\n\n  /**\n   * @inheritDoc\n   */\n  public toJSON(): {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    data?: { [key: string]: any };\n    description?: string;\n    op?: string;\n    parent_span_id?: string;\n    span_id: string;\n    start_timestamp: number;\n    status?: string;\n    tags?: { [key: string]: Primitive };\n    timestamp?: number;\n    trace_id: string;\n  } {\n    return dropUndefinedKeys({\n      data: Object.keys(this.data).length > 0 ? this.data : undefined,\n      description: this.description,\n      op: this.op,\n      parent_span_id: this.parentSpanId,\n      span_id: this.spanId,\n      start_timestamp: this.startTimestamp,\n      status: this.status,\n      tags: Object.keys(this.tags).length > 0 ? this.tags : undefined,\n      timestamp: this.endTimestamp,\n      trace_id: this.traceId,\n    });\n  }\n}\n\nexport type SpanStatusType =\n  /** The operation completed successfully. */\n  | 'ok'\n  /** Deadline expired before operation could complete. */\n  | 'deadline_exceeded'\n  /** 401 Unauthorized (actually does mean unauthenticated according to RFC 7235) */\n  | 'unauthenticated'\n  /** 403 Forbidden */\n  | 'permission_denied'\n  /** 404 Not Found. Some requested entity (file or directory) was not found. */\n  | 'not_found'\n  /** 429 Too Many Requests */\n  | 'resource_exhausted'\n  /** Client specified an invalid argument. 4xx. */\n  | 'invalid_argument'\n  /** 501 Not Implemented */\n  | 'unimplemented'\n  /** 503 Service Unavailable */\n  | 'unavailable'\n  /** Other/generic 5xx. */\n  | 'internal_error'\n  /** Unknown. Any non-standard HTTP status code. */\n  | 'unknown_error'\n  /** The operation was cancelled (typically by the user). */\n  | 'cancelled'\n  /** Already exists (409) */\n  | 'already_exists'\n  /** Operation was rejected because the system is not in a state required for the operation's */\n  | 'failed_precondition'\n  /** The operation was aborted, typically due to a concurrency issue. */\n  | 'aborted'\n  /** Operation was attempted past the valid range. */\n  | 'out_of_range'\n  /** Unrecoverable data loss or corruption */\n  | 'data_loss';\n\n/**\n * Converts a HTTP status code into a {@link SpanStatusType}.\n *\n * @param httpStatus The HTTP response status code.\n * @returns The span status or unknown_error.\n */\nexport function spanStatusfromHttpCode(httpStatus: number): SpanStatusType {\n  if (httpStatus < 400 && httpStatus >= 100) {\n    return 'ok';\n  }\n\n  if (httpStatus >= 400 && httpStatus < 500) {\n    switch (httpStatus) {\n      case 401:\n        return 'unauthenticated';\n      case 403:\n        return 'permission_denied';\n      case 404:\n        return 'not_found';\n      case 409:\n        return 'already_exists';\n      case 413:\n        return 'failed_precondition';\n      case 429:\n        return 'resource_exhausted';\n      default:\n        return 'invalid_argument';\n    }\n  }\n\n  if (httpStatus >= 500 && httpStatus < 600) {\n    switch (httpStatus) {\n      case 501:\n        return 'unimplemented';\n      case 503:\n        return 'unavailable';\n      case 504:\n        return 'deadline_exceeded';\n      default:\n        return 'internal_error';\n    }\n  }\n\n  return 'unknown_error';\n}\n"]},"metadata":{},"sourceType":"module"}