{"ast":null,"code":"import { DEFAULT_ENVIRONMENT } from '@sentry/core';\nimport { logger, uuid4, createEnvelope, dsnToString, dropUndefinedKeys } from '@sentry/utils';\nimport { WINDOW } from '../helpers.js';\nconst MS_TO_NS = 1e6;\n// Use 0 as main thread id which is identical to threadId in node:worker_threads\n// where main logs 0 and workers seem to log in increments of 1\nconst THREAD_ID_STRING = String(0);\nconst THREAD_NAME = 'main';\n\n// Machine properties (eval only once)\nlet OS_PLATFORM = ''; // macos\nlet OS_PLATFORM_VERSION = ''; // 13.2\nlet OS_ARCH = ''; // arm64\nlet OS_BROWSER = WINDOW.navigator && WINDOW.navigator.userAgent || '';\nlet OS_MODEL = '';\nconst OS_LOCALE = WINDOW.navigator && WINDOW.navigator.language || WINDOW.navigator && WINDOW.navigator.languages && WINDOW.navigator.languages[0] || '';\nfunction isUserAgentData(data) {\n  return typeof data === 'object' && data !== null && 'getHighEntropyValues' in data;\n}\n\n// @ts-ignore userAgentData is not part of the navigator interface yet\nconst userAgentData = WINDOW.navigator && WINDOW.navigator.userAgentData;\nif (isUserAgentData(userAgentData)) {\n  userAgentData.getHighEntropyValues(['architecture', 'model', 'platform', 'platformVersion', 'fullVersionList']).then(ua => {\n    OS_PLATFORM = ua.platform || '';\n    OS_ARCH = ua.architecture || '';\n    OS_MODEL = ua.model || '';\n    OS_PLATFORM_VERSION = ua.platformVersion || '';\n    if (ua.fullVersionList && ua.fullVersionList.length > 0) {\n      const firstUa = ua.fullVersionList[ua.fullVersionList.length - 1];\n      OS_BROWSER = `${firstUa.brand} ${firstUa.version}`;\n    }\n  }).catch(e => void e);\n}\nfunction isRawThreadCpuProfile(profile) {\n  return !('thread_metadata' in profile);\n}\n\n// Enriches the profile with threadId of the current thread.\n// This is done in node as we seem to not be able to get the info from C native code.\n/**\n *\n */\nfunction enrichWithThreadInformation(profile) {\n  if (!isRawThreadCpuProfile(profile)) {\n    return profile;\n  }\n  return convertJSSelfProfileToSampledFormat(profile);\n}\n\n// Profile is marked as optional because it is deleted from the metadata\n// by the integration before the event is processed by other integrations.\n\n/** Extract sdk info from from the API metadata */\nfunction getSdkMetadataForEnvelopeHeader(metadata) {\n  if (!metadata || !metadata.sdk) {\n    return undefined;\n  }\n  return {\n    name: metadata.sdk.name,\n    version: metadata.sdk.version\n  };\n}\n\n/**\n * Apply SdkInfo (name, version, packages, integrations) to the corresponding event key.\n * Merge with existing data if any.\n **/\nfunction enhanceEventWithSdkInfo(event, sdkInfo) {\n  if (!sdkInfo) {\n    return event;\n  }\n  event.sdk = event.sdk || {};\n  event.sdk.name = event.sdk.name || sdkInfo.name || 'unknown sdk';\n  event.sdk.version = event.sdk.version || sdkInfo.version || 'unknown sdk version';\n  event.sdk.integrations = [...(event.sdk.integrations || []), ...(sdkInfo.integrations || [])];\n  event.sdk.packages = [...(event.sdk.packages || []), ...(sdkInfo.packages || [])];\n  return event;\n}\nfunction createEventEnvelopeHeaders(event, sdkInfo, tunnel, dsn) {\n  const dynamicSamplingContext = event.sdkProcessingMetadata && event.sdkProcessingMetadata['dynamicSamplingContext'];\n  return {\n    event_id: event.event_id,\n    sent_at: new Date().toISOString(),\n    ...(sdkInfo && {\n      sdk: sdkInfo\n    }),\n    ...(!!tunnel && {\n      dsn: dsnToString(dsn)\n    }),\n    ...(event.type === 'transaction' && dynamicSamplingContext && {\n      trace: dropUndefinedKeys({\n        ...dynamicSamplingContext\n      })\n    })\n  };\n}\nfunction getTraceId(event) {\n  const traceId = event && event.contexts && event.contexts['trace'] && event.contexts['trace']['trace_id'];\n  // Log a warning if the profile has an invalid traceId (should be uuidv4).\n  // All profiles and transactions are rejected if this is the case and we want to\n  // warn users that this is happening if they enable debug flag\n  if (typeof traceId === 'string' && traceId.length !== 32) {\n    if (typeof __SENTRY_DEBUG__ === 'undefined' || __SENTRY_DEBUG__) {\n      logger.log(`[Profiling] Invalid traceId: ${traceId} on profiled event`);\n    }\n  }\n  if (typeof traceId !== 'string') {\n    return '';\n  }\n  return traceId;\n}\n/**\n * Creates a profiling event envelope from a Sentry event. If profile does not pass\n * validation, returns null.\n * @param event\n * @param dsn\n * @param metadata\n * @param tunnel\n * @returns {EventEnvelope | null}\n */\n\n/**\n * Creates a profiling event envelope from a Sentry event.\n */\nfunction createProfilingEventEnvelope(event, dsn, metadata, tunnel) {\n  if (event.type !== 'transaction') {\n    // createProfilingEventEnvelope should only be called for transactions,\n    // we type guard this behavior with isProfiledTransactionEvent.\n    throw new TypeError('Profiling events may only be attached to transactions, this should never occur.');\n  }\n  const rawProfile = event.sdkProcessingMetadata['profile'];\n  if (rawProfile === undefined || rawProfile === null) {\n    throw new TypeError(`Cannot construct profiling event envelope without a valid profile. Got ${rawProfile} instead.`);\n  }\n  if (!rawProfile.profile_id) {\n    throw new TypeError('Profile is missing profile_id');\n  }\n  if (rawProfile.samples.length <= 1) {\n    if (typeof __SENTRY_DEBUG__ === 'undefined' || __SENTRY_DEBUG__) {\n      // Log a warning if the profile has less than 2 samples so users can know why\n      // they are not seeing any profiling data and we cant avoid the back and forth\n      // of asking them to provide us with a dump of the profile data.\n      logger.log('[Profiling] Discarding profile because it contains less than 2 samples');\n    }\n    return null;\n  }\n  const traceId = getTraceId(event);\n  const sdkInfo = getSdkMetadataForEnvelopeHeader(metadata);\n  enhanceEventWithSdkInfo(event, metadata && metadata.sdk);\n  const envelopeHeaders = createEventEnvelopeHeaders(event, sdkInfo, tunnel, dsn);\n  const enrichedThreadProfile = enrichWithThreadInformation(rawProfile);\n  const transactionStartMs = typeof event.start_timestamp === 'number' ? event.start_timestamp * 1000 : Date.now();\n  const transactionEndMs = typeof event.timestamp === 'number' ? event.timestamp * 1000 : Date.now();\n  const profile = {\n    event_id: rawProfile.profile_id,\n    timestamp: new Date(transactionStartMs).toISOString(),\n    platform: 'javascript',\n    version: '1',\n    release: event.release || '',\n    environment: event.environment || DEFAULT_ENVIRONMENT,\n    runtime: {\n      name: 'javascript',\n      version: WINDOW.navigator.userAgent\n    },\n    os: {\n      name: OS_PLATFORM,\n      version: OS_PLATFORM_VERSION,\n      build_number: OS_BROWSER\n    },\n    device: {\n      locale: OS_LOCALE,\n      model: OS_MODEL,\n      manufacturer: OS_BROWSER,\n      architecture: OS_ARCH,\n      is_emulator: false\n    },\n    profile: enrichedThreadProfile,\n    transactions: [{\n      name: event.transaction || '',\n      id: event.event_id || uuid4(),\n      trace_id: traceId,\n      active_thread_id: THREAD_ID_STRING,\n      relative_start_ns: '0',\n      relative_end_ns: ((transactionEndMs - transactionStartMs) * 1e6).toFixed(0)\n    }]\n  };\n  const envelopeItem = [{\n    type: 'profile'\n  },\n  // @ts-ignore this is missing in typedef\n  profile];\n  return createEnvelope(envelopeHeaders, [envelopeItem]);\n}\n\n/**\n * Converts a JSSelfProfile to a our sampled format.\n * Does not currently perform stack indexing.\n */\nfunction convertJSSelfProfileToSampledFormat(input) {\n  let EMPTY_STACK_ID = undefined;\n  let STACK_ID = 0;\n\n  // Initialize the profile that we will fill with data\n  const profile = {\n    samples: [],\n    stacks: [],\n    frames: [],\n    thread_metadata: {\n      [THREAD_ID_STRING]: {\n        name: THREAD_NAME\n      }\n    }\n  };\n  if (!input.samples.length) {\n    return profile;\n  }\n\n  // We assert samples.length > 0 above and timestamp should always be present\n  const start = input.samples[0].timestamp;\n  for (let i = 0; i < input.samples.length; i++) {\n    const jsSample = input.samples[i];\n\n    // If sample has no stack, add an empty sample\n    if (jsSample.stackId === undefined) {\n      if (EMPTY_STACK_ID === undefined) {\n        EMPTY_STACK_ID = STACK_ID;\n        profile.stacks[EMPTY_STACK_ID] = [];\n        STACK_ID++;\n      }\n      profile['samples'][i] = {\n        // convert ms timestamp to ns\n        elapsed_since_start_ns: ((jsSample.timestamp - start) * MS_TO_NS).toFixed(0),\n        stack_id: EMPTY_STACK_ID,\n        thread_id: THREAD_ID_STRING\n      };\n      continue;\n    }\n    let stackTop = input.stacks[jsSample.stackId];\n\n    // Functions in top->down order (root is last)\n    // We follow the stackTop.parentId trail and collect each visited frameId\n    const stack = [];\n    while (stackTop) {\n      stack.push(stackTop.frameId);\n      const frame = input.frames[stackTop.frameId];\n\n      // If our frame has not been indexed yet, index it\n      if (profile.frames[stackTop.frameId] === undefined) {\n        profile.frames[stackTop.frameId] = {\n          function: frame.name,\n          file: frame.resourceId ? input.resources[frame.resourceId] : undefined,\n          line: frame.line,\n          column: frame.column\n        };\n      }\n      stackTop = stackTop.parentId === undefined ? undefined : input.stacks[stackTop.parentId];\n    }\n    const sample = {\n      // convert ms timestamp to ns\n      elapsed_since_start_ns: ((jsSample.timestamp - start) * MS_TO_NS).toFixed(0),\n      stack_id: STACK_ID,\n      thread_id: THREAD_ID_STRING\n    };\n    profile['stacks'][STACK_ID] = stack;\n    profile['samples'][i] = sample;\n    STACK_ID++;\n  }\n  return profile;\n}\nexport { convertJSSelfProfileToSampledFormat, createProfilingEventEnvelope, enrichWithThreadInformation };","map":{"version":3,"sources":["../../../../src/profiling/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { DEFAULT_ENVIRONMENT } from '@sentry/core';\nimport type {\n  DsnComponents,\n  DynamicSamplingContext,\n  Event,\n  EventEnvelope,\n  EventEnvelopeHeaders,\n  EventItem,\n  SdkInfo,\n  SdkMetadata,\n} from '@sentry/types';\nimport { createEnvelope, dropUndefinedKeys, dsnToString, logger, uuid4 } from '@sentry/utils';\n\nimport { WINDOW } from '../helpers';\nimport type {\n  JSSelfProfile,\n  JSSelfProfileStack,\n  RawThreadCpuProfile,\n  SentryProfile,\n  ThreadCpuProfile,\n} from './jsSelfProfiling';\n\nconst MS_TO_NS = 1e6;\n// Use 0 as main thread id which is identical to threadId in node:worker_threads\n// where main logs 0 and workers seem to log in increments of 1\nconst THREAD_ID_STRING = String(0);\nconst THREAD_NAME = 'main';\n\n// Machine properties (eval only once)\nlet OS_PLATFORM = ''; // macos\nlet OS_PLATFORM_VERSION = ''; // 13.2\nlet OS_ARCH = ''; // arm64\nlet OS_BROWSER = (WINDOW.navigator && WINDOW.navigator.userAgent) || '';\nlet OS_MODEL = '';\nconst OS_LOCALE =\n  (WINDOW.navigator && WINDOW.navigator.language) ||\n  (WINDOW.navigator && WINDOW.navigator.languages && WINDOW.navigator.languages[0]) ||\n  '';\n\ntype UAData = {\n  platform?: string;\n  architecture?: string;\n  model?: string;\n  platformVersion?: string;\n  fullVersionList?: {\n    brand: string;\n    version: string;\n  }[];\n};\n\ninterface UserAgentData {\n  getHighEntropyValues: (keys: string[]) => Promise<UAData>;\n}\n\nfunction isUserAgentData(data: unknown): data is UserAgentData {\n  return typeof data === 'object' && data !== null && 'getHighEntropyValues' in data;\n}\n\n// @ts-ignore userAgentData is not part of the navigator interface yet\nconst userAgentData = WINDOW.navigator && WINDOW.navigator.userAgentData;\n\nif (isUserAgentData(userAgentData)) {\n  userAgentData\n    .getHighEntropyValues(['architecture', 'model', 'platform', 'platformVersion', 'fullVersionList'])\n    .then((ua: UAData) => {\n      OS_PLATFORM = ua.platform || '';\n      OS_ARCH = ua.architecture || '';\n      OS_MODEL = ua.model || '';\n      OS_PLATFORM_VERSION = ua.platformVersion || '';\n\n      if (ua.fullVersionList && ua.fullVersionList.length > 0) {\n        const firstUa = ua.fullVersionList[ua.fullVersionList.length - 1];\n        OS_BROWSER = `${firstUa.brand} ${firstUa.version}`;\n      }\n    })\n    .catch(e => void e);\n}\n\nfunction isRawThreadCpuProfile(profile: ThreadCpuProfile | RawThreadCpuProfile): profile is RawThreadCpuProfile {\n  return !('thread_metadata' in profile);\n}\n\n// Enriches the profile with threadId of the current thread.\n// This is done in node as we seem to not be able to get the info from C native code.\n/**\n *\n */\nexport function enrichWithThreadInformation(profile: ThreadCpuProfile | RawThreadCpuProfile): ThreadCpuProfile {\n  if (!isRawThreadCpuProfile(profile)) {\n    return profile;\n  }\n\n  return convertJSSelfProfileToSampledFormat(profile);\n}\n\n// Profile is marked as optional because it is deleted from the metadata\n// by the integration before the event is processed by other integrations.\nexport interface ProfiledEvent extends Event {\n  sdkProcessingMetadata: {\n    profile?: RawThreadCpuProfile;\n  };\n}\n\n/** Extract sdk info from from the API metadata */\nfunction getSdkMetadataForEnvelopeHeader(metadata?: SdkMetadata): SdkInfo | undefined {\n  if (!metadata || !metadata.sdk) {\n    return undefined;\n  }\n\n  return { name: metadata.sdk.name, version: metadata.sdk.version } as SdkInfo;\n}\n\n/**\n * Apply SdkInfo (name, version, packages, integrations) to the corresponding event key.\n * Merge with existing data if any.\n **/\nfunction enhanceEventWithSdkInfo(event: Event, sdkInfo?: SdkInfo): Event {\n  if (!sdkInfo) {\n    return event;\n  }\n  event.sdk = event.sdk || {};\n  event.sdk.name = event.sdk.name || sdkInfo.name || 'unknown sdk';\n  event.sdk.version = event.sdk.version || sdkInfo.version || 'unknown sdk version';\n  event.sdk.integrations = [...(event.sdk.integrations || []), ...(sdkInfo.integrations || [])];\n  event.sdk.packages = [...(event.sdk.packages || []), ...(sdkInfo.packages || [])];\n  return event;\n}\n\nfunction createEventEnvelopeHeaders(\n  event: Event,\n  sdkInfo: SdkInfo | undefined,\n  tunnel: string | undefined,\n  dsn: DsnComponents,\n): EventEnvelopeHeaders {\n  const dynamicSamplingContext = event.sdkProcessingMetadata && event.sdkProcessingMetadata['dynamicSamplingContext'];\n\n  return {\n    event_id: event.event_id as string,\n    sent_at: new Date().toISOString(),\n    ...(sdkInfo && { sdk: sdkInfo }),\n    ...(!!tunnel && { dsn: dsnToString(dsn) }),\n    ...(event.type === 'transaction' &&\n      dynamicSamplingContext && {\n        trace: dropUndefinedKeys({ ...dynamicSamplingContext }) as DynamicSamplingContext,\n      }),\n  };\n}\n\nfunction getTraceId(event: Event): string {\n  const traceId: unknown = event && event.contexts && event.contexts['trace'] && event.contexts['trace']['trace_id'];\n  // Log a warning if the profile has an invalid traceId (should be uuidv4).\n  // All profiles and transactions are rejected if this is the case and we want to\n  // warn users that this is happening if they enable debug flag\n  if (typeof traceId === 'string' && traceId.length !== 32) {\n    if (__DEBUG_BUILD__) {\n      logger.log(`[Profiling] Invalid traceId: ${traceId} on profiled event`);\n    }\n  }\n  if (typeof traceId !== 'string') {\n    return '';\n  }\n\n  return traceId;\n}\n/**\n * Creates a profiling event envelope from a Sentry event. If profile does not pass\n * validation, returns null.\n * @param event\n * @param dsn\n * @param metadata\n * @param tunnel\n * @returns {EventEnvelope | null}\n */\n\n/**\n * Creates a profiling event envelope from a Sentry event.\n */\nexport function createProfilingEventEnvelope(\n  event: ProfiledEvent,\n  dsn: DsnComponents,\n  metadata?: SdkMetadata,\n  tunnel?: string,\n): EventEnvelope | null {\n  if (event.type !== 'transaction') {\n    // createProfilingEventEnvelope should only be called for transactions,\n    // we type guard this behavior with isProfiledTransactionEvent.\n    throw new TypeError('Profiling events may only be attached to transactions, this should never occur.');\n  }\n\n  const rawProfile = event.sdkProcessingMetadata['profile'];\n\n  if (rawProfile === undefined || rawProfile === null) {\n    throw new TypeError(\n      `Cannot construct profiling event envelope without a valid profile. Got ${rawProfile} instead.`,\n    );\n  }\n\n  if (!rawProfile.profile_id) {\n    throw new TypeError('Profile is missing profile_id');\n  }\n\n  if (rawProfile.samples.length <= 1) {\n    if (__DEBUG_BUILD__) {\n      // Log a warning if the profile has less than 2 samples so users can know why\n      // they are not seeing any profiling data and we cant avoid the back and forth\n      // of asking them to provide us with a dump of the profile data.\n      logger.log('[Profiling] Discarding profile because it contains less than 2 samples');\n    }\n    return null;\n  }\n\n  const traceId = getTraceId(event);\n  const sdkInfo = getSdkMetadataForEnvelopeHeader(metadata);\n  enhanceEventWithSdkInfo(event, metadata && metadata.sdk);\n  const envelopeHeaders = createEventEnvelopeHeaders(event, sdkInfo, tunnel, dsn);\n  const enrichedThreadProfile = enrichWithThreadInformation(rawProfile);\n  const transactionStartMs = typeof event.start_timestamp === 'number' ? event.start_timestamp * 1000 : Date.now();\n  const transactionEndMs = typeof event.timestamp === 'number' ? event.timestamp * 1000 : Date.now();\n\n  const profile: SentryProfile = {\n    event_id: rawProfile.profile_id,\n    timestamp: new Date(transactionStartMs).toISOString(),\n    platform: 'javascript',\n    version: '1',\n    release: event.release || '',\n    environment: event.environment || DEFAULT_ENVIRONMENT,\n    runtime: {\n      name: 'javascript',\n      version: WINDOW.navigator.userAgent,\n    },\n    os: {\n      name: OS_PLATFORM,\n      version: OS_PLATFORM_VERSION,\n      build_number: OS_BROWSER,\n    },\n    device: {\n      locale: OS_LOCALE,\n      model: OS_MODEL,\n      manufacturer: OS_BROWSER,\n      architecture: OS_ARCH,\n      is_emulator: false,\n    },\n    profile: enrichedThreadProfile,\n    transactions: [\n      {\n        name: event.transaction || '',\n        id: event.event_id || uuid4(),\n        trace_id: traceId,\n        active_thread_id: THREAD_ID_STRING,\n        relative_start_ns: '0',\n        relative_end_ns: ((transactionEndMs - transactionStartMs) * 1e6).toFixed(0),\n      },\n    ],\n  };\n\n  const envelopeItem: EventItem = [\n    {\n      type: 'profile',\n    },\n    // @ts-ignore this is missing in typedef\n    profile,\n  ];\n\n  return createEnvelope<EventEnvelope>(envelopeHeaders, [envelopeItem]);\n}\n\n/**\n *\n */\nexport function isProfiledTransactionEvent(event: Event): event is ProfiledEvent {\n  return !!(event.sdkProcessingMetadata && event.sdkProcessingMetadata['profile']);\n}\n\n// Due to how profiles are attached to event metadata, we may sometimes want to remove them to ensure\n// they are not processed by other Sentry integrations. This can be the case when we cannot construct a valid\n// profile from the data we have or some of the mechanisms to send the event (Hub, Transport etc) are not available to us.\n/**\n *\n */\nexport function maybeRemoveProfileFromSdkMetadata(event: Event | ProfiledEvent): Event {\n  if (!isProfiledTransactionEvent(event)) {\n    return event;\n  }\n\n  delete event.sdkProcessingMetadata.profile;\n  return event;\n}\n\n/**\n * Converts a JSSelfProfile to a our sampled format.\n * Does not currently perform stack indexing.\n */\nexport function convertJSSelfProfileToSampledFormat(input: JSSelfProfile): ThreadCpuProfile {\n  let EMPTY_STACK_ID: undefined | number = undefined;\n  let STACK_ID = 0;\n\n  // Initialize the profile that we will fill with data\n  const profile: ThreadCpuProfile = {\n    samples: [],\n    stacks: [],\n    frames: [],\n    thread_metadata: {\n      [THREAD_ID_STRING]: { name: THREAD_NAME },\n    },\n  };\n\n  if (!input.samples.length) {\n    return profile;\n  }\n\n  // We assert samples.length > 0 above and timestamp should always be present\n  const start = input.samples[0].timestamp;\n\n  for (let i = 0; i < input.samples.length; i++) {\n    const jsSample = input.samples[i];\n\n    // If sample has no stack, add an empty sample\n    if (jsSample.stackId === undefined) {\n      if (EMPTY_STACK_ID === undefined) {\n        EMPTY_STACK_ID = STACK_ID;\n        profile.stacks[EMPTY_STACK_ID] = [];\n        STACK_ID++;\n      }\n\n      profile['samples'][i] = {\n        // convert ms timestamp to ns\n        elapsed_since_start_ns: ((jsSample.timestamp - start) * MS_TO_NS).toFixed(0),\n        stack_id: EMPTY_STACK_ID,\n        thread_id: THREAD_ID_STRING,\n      };\n      continue;\n    }\n\n    let stackTop: JSSelfProfileStack | undefined = input.stacks[jsSample.stackId];\n\n    // Functions in top->down order (root is last)\n    // We follow the stackTop.parentId trail and collect each visited frameId\n    const stack: number[] = [];\n\n    while (stackTop) {\n      stack.push(stackTop.frameId);\n\n      const frame = input.frames[stackTop.frameId];\n\n      // If our frame has not been indexed yet, index it\n      if (profile.frames[stackTop.frameId] === undefined) {\n        profile.frames[stackTop.frameId] = {\n          function: frame.name,\n          file: frame.resourceId ? input.resources[frame.resourceId] : undefined,\n          line: frame.line,\n          column: frame.column,\n        };\n      }\n\n      stackTop = stackTop.parentId === undefined ? undefined : input.stacks[stackTop.parentId];\n    }\n\n    const sample: ThreadCpuProfile['samples'][0] = {\n      // convert ms timestamp to ns\n      elapsed_since_start_ns: ((jsSample.timestamp - start) * MS_TO_NS).toFixed(0),\n      stack_id: STACK_ID,\n      thread_id: THREAD_ID_STRING,\n    };\n\n    profile['stacks'][STACK_ID] = stack;\n    profile['samples'][i] = sample;\n    STACK_ID++;\n  }\n\n  return profile;\n}\n"]},"metadata":{},"sourceType":"module"}